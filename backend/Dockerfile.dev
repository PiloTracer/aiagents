# backend/Dockerfile
FROM python:3.13.7-bookworm

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    LANG=C.UTF-8

WORKDIR /app

# System deps:
# - poppler-utils: helpful for PDFs
# - libreoffice: optional conversions you already used
# - tesseract-ocr + ENG + SPA language packs
# - libtesseract-dev: lib headers (some environments need it)
# - fonts/locales: better OCR on Latin scripts
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    poppler-utils \
    libreoffice \
    tesseract-ocr \
    tesseract-ocr-eng \
    tesseract-ocr-spa \
    libtesseract-dev \
    locales \
    fonts-dejavu \
    libgl1 \
    libglib2.0-0 \
    libgtk2.0-0 \
    libsm6 \
    libxext6 \
    libxrender1 \
 && rm -rf /var/lib/apt/lists/*

# Ensure Tesseract looks in the right place for traineddata
ENV TESSDATA_PREFIX=/usr/share/tesseract-ocr/5/tessdata

# Validate that language data is there (fail build if missing)
RUN test -f "$TESSDATA_PREFIX/eng.traineddata" && \
    test -f "$TESSDATA_PREFIX/spa.traineddata" && \
    tesseract --version && tesseract --list-langs

# Python deps and app
COPY pyproject.toml /app/
COPY bin /app/bin
COPY app /app/app
RUN pip install --upgrade pip && pip install -e .
RUN pip install "openai>=1.52.0"
RUN pip install debugpy
RUN chmod +x /app/bin/docling_vlm.sh /app/bin/start-dev.sh

EXPOSE 8000
CMD ["bash", "/app/bin/start-dev.sh"]
